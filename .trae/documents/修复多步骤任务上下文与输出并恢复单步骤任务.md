## 问题定位
- 接口签名不匹配：`LLMAgent.validate_step_result(self, step, context)` 实际被调用为 `validate_step_result(step, result, context)`，导致 `TypeError`，使多/单步骤执行均失败（`src/open_codex/executors/multistep_executor.py:85`，接口定义见 `src/open_codex/interfaces/llm_agent.py:57–68`）。
- 错误处理返回类型不一致：接口声明 `handle_step_error(...) -> TaskStep`，执行器将其结果写入 `step.result`（期望 `str`），造成类型污染（`executors/multistep_executor.py:102–108`，接口见 `interfaces/llm_agent.py:70–82`）。
- 输出与传递不统一：
  - 主流程单步命令执行未捕获输出（`src/open_codex/main.py:121`），导致结果只能直接在子进程终端显示，无法进入 `context/step.result`。
  - 颜色常量在 Windows 终端不生效（`main.py:17–20`），缺少 `colorama.init()` 与降级开关。
  - 未统一日志初始化，`print` 与 `logger` 混用，错误位置不一致（多处见 `main.py` 与 `agents/*`）。
- 会话恢复不完整：`resume_session(...)` 仅加载 `context`，未重建 `Agent/Executor` 并继续执行（`src/open_codex/main.py:273–285`）。
- 平台与编码边界：Windows 键盘读取与终端编码可能引发异常或乱码（`main.py:53`）。

## 修复方案
1) 统一验证方法调用
- 修改执行器调用为两参版本：`self.agent.validate_step_result(step, context)`（替换 `executors/multistep_executor.py:85`）。
- 若具体 Agent 需要使用结果文本，统一改为从 `step.result` 读取，不额外传参。

2) 规范错误处理返回
- 保持接口返回 `TaskStep` 一致（`interfaces/llm_agent.py:70–82`）。
- 执行器在恢复时用返回对象替换当前步骤：`step = recovery_step`，并写回 `context.steps[i] = step`；不再写入 `step.result = recovery_result`（更新 `executors/multistep_executor.py:102–108`）。

3) 修复单步骤执行与输出传递
- 在单步骤路径中，捕获并呈现命令执行结果：`subprocess.run(command, shell=True, capture_output=True, text=True)`；将 `stdout/stderr/returncode` 整理为字符串并显示/写入（更新 `src/open_codex/main.py:121`）。
- 明确单步入口：确认 `main()` 的 `--multistep` 分支与默认单步分支工作正常（`src/open_codex/main.py:354–363`）；确保单步路径不依赖多步执行器。

4) 统一日志与颜色输出
- 在入口初始化日志：`logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(name)s: %(message)s')`。
- Windows 初始化颜色：`import colorama; colorama.init()`；当终端不支持 ANSI 时提供禁用彩色开关（环境变量或 CLI 标志）（涉及 `src/open_codex/main.py:17–20`）。
- 保留用户交互 `print`，将非交互状态信息改用 `logger.info/error`；错误优先写入 `stderr`（多处 `main.py`）。

5) 强化子进程兼容性
- Windows：检测 `powershell` 不可用时，回退到 `cmd /c` 并在返回字符串中明确提示（`src/open_codex/agents/ollama_agent.py:176–181`、`litellm_agent.py:160–165`）。
- 非 Windows：如命令含 Bash 语法，指定 `executable='/bin/bash'`（`ollama_agent.py:184–190`、`litellm_agent.py:168–174`）。
- 对 `stdout/stderr` 使用 `rstrip()`，提升输出整洁度（`ollama_agent.py:193–197`、`litellm_agent.py:177–181`）。

6) 完成会话恢复
- 在 `resume_session(...)` 基于 `context` 重建对应 `Agent/Executor`，并调用 `executor.resume_task(context)`，实现真正恢复执行（`src/open_codex/main.py:273–285`）。

7) 编码与键盘读取
- 入口处尝试 `sys.stdout/sys.stderr` 设为 `utf-8`；`getch().decode('utf-8', errors='ignore')` 以避免异常（`src/open_codex/main.py:53`）。

8) 示例与测试同步（可并行执行）
- 更新示例与测试为现有 `TaskContext/TaskStep` 字段与包结构，移除旧字段（如 `task_description/estimated_time/PAUSED`），确保 CI 可运行（示例：`src/open_codex/examples/multistep_example.py:104–125`，测试：`src/open_codex/tests/test_multistep.py` 多处）。

## 验证方案
- 单步验证：在 Windows 与 Linux 各运行一次单步命令，确认 `stdout/stderr` 被捕获并正确显示与返回。
- 多步验证：构造 3 步含依赖的任务，验证执行顺序、失败恢复（替换步骤对象）与进度统计。
- 恢复验证：执行到第 2 步暂停，退出后 `--resume` 恢复并继续到完成。
- 日志与颜色：在 Windows 终端确认颜色与日志格式正常；在不支持 ANSI 的终端禁用颜色时无异常。

## 风险与回滚
- 变更范围集中在执行器调用与主流程输出；如出现回归，可回滚到修改前的两处关键点（`multistep_executor.py` 的两处调用与 `main.py` 的单步执行）。

## 预计用时
- 修复与本地验证：约 2–4 小时（含跨平台核验）。
- 示例与测试同步：约 2 小时（可并行）。